<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - AI Agent Platform</title>
  <style>
    * { box-sizing: border-box; }
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif; 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
      margin: 0; 
      min-height: 100vh;
      color: #333;
    }
    .container { 
      max-width: 1200px; 
      margin: 20px auto; 
      background: #fff; 
      border-radius: 16px; 
      box-shadow: 0 20px 40px rgba(0,0,0,0.1); 
      padding: 32px; 
      position: relative;
    }
    h1 { 
      color: #2c3e50; 
      margin-bottom: 30px; 
      font-size: 2.5em; 
      font-weight: 700;
      text-align: center;
    }
    h2 { 
      color: #34495e; 
      margin-bottom: 20px; 
      font-size: 1.8em;
      border-bottom: 3px solid #3498db;
      padding-bottom: 10px;
    }
    h3 { 
      color: #2c3e50; 
      margin-bottom: 15px; 
      font-size: 1.4em;
    }
    button {
      background: #3498db;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.3s ease;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    button:hover {
      background: #2980b9;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    button:active {
      transform: translateY(0);
    }
    .logout-btn { 
      background: #e74c3c; 
      float: right; 
      margin-top: 10px; 
      position: absolute;
      top: 20px;
      right: 20px;
    }
    .logout-btn:hover { 
      background: #c0392b; 
    }
    .agent-form {
      background: #f8f9fa;
      padding: 25px;
      border-radius: 12px;
      margin-bottom: 30px;
      border: 1px solid #e9ecef;
    }
    .agent-card { 
      transition: all 0.3s ease; 
      box-shadow: 0 4px 12px rgba(0,0,0,0.08); 
      border-radius: 12px; 
      background: #fff; 
      padding: 25px; 
      margin-bottom: 20px; 
      border: 1px solid #e9ecef;
      position: relative;
    }
    .agent-card:hover { 
      box-shadow: 0 8px 25px rgba(0,0,0,0.15); 
      transform: translateY(-2px);
    }
    .agent-card h4 {
      color: #2c3e50;
      margin: 0 0 15px 0;
      font-size: 1.3em;
      font-weight: 600;
    }
    .agent-actions { 
      margin-top: 15px; 
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    .agent-actions button, .deployment-options button { 
      display: inline-flex; 
      align-items: center; 
      gap: 6px; 
      margin-right: 6px; 
      font-size: 13px;
      padding: 8px 16px;
    }
    .delete-btn {
      background: #e74c3c;
    }
    .delete-btn:hover {
      background: #c0392b;
    }
    .deploy-btn {
      background: #27ae60;
    }
    .deploy-btn:hover {
      background: #229954;
    }
    .train-btn {
      background: #f39c12;
    }
    .train-btn:hover {
      background: #e67e22;
    }
    .whatsapp-deploy-btn {
      background: #25d366;
    }
    .whatsapp-deploy-btn:hover {
      background: #128c7e;
    }
    .telegram-deploy-btn {
      background: #0088cc;
    }
    .telegram-deploy-btn:hover {
      background: #006699;
    }
    .deployment-options { 
      margin-bottom: 15px; 
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    .status-badge { 
      display: inline-block; 
      padding: 4px 12px; 
      border-radius: 20px; 
      font-size: 0.85em; 
      font-weight: 600; 
      margin-left: 8px; 
    }
    .status-badge.connected { background: #d4edda; color: #155724; }
    .status-badge.disconnected { background: #f8d7da; color: #721c24; }
    .status-badge.qr { background: #fff3cd; color: #856404; }
    .status-badge.error { background: #f8d7da; color: #721c24; }
    .status-badge.unknown { background: #e2e3e5; color: #383d41; }
    .spinner { 
      border: 4px solid #f3f3f3; 
      border-top: 4px solid #3498db; 
      border-radius: 50%; 
      width: 40px; 
      height: 40px; 
      animation: spin 1s linear infinite; 
    }
    @keyframes spin { 
      0% { transform: rotate(0deg); } 
      100% { transform: rotate(360deg); } 
    }
    #loadingOverlay { 
      display:none; 
      position:fixed; 
      top:0; 
      left:0; 
      width:100vw; 
      height:100vh; 
      background:rgba(255,255,255,0.9); 
      z-index:9999; 
      align-items:center; 
      justify-content:center; 
    }
    #toast { 
      min-width: 280px; 
      background: #333; 
      color: #fff; 
      padding: 16px 24px; 
      border-radius: 8px; 
      font-size: 14px; 
      box-shadow: 0 4px 12px rgba(0,0,0,0.15); 
      opacity: 0.95; 
      transition: all 0.3s; 
      position:fixed; 
      bottom:30px; 
      right:30px; 
      z-index:10000; 
      display:none; 
    }
    #toast.success { background: #27ae60; }
    #toast.error { background: #e74c3c; }
    #toast.info { background: #3498db; }
    .form-group { 
      margin-bottom: 20px; 
    }
    label { 
      display: block; 
      margin-bottom: 8px; 
      color: #2c3e50; 
      font-weight: 600; 
      font-size: 14px;
    }
    input, select, textarea { 
      width: 100%; 
      padding: 12px; 
      border: 2px solid #e9ecef; 
      border-radius: 8px; 
      box-sizing: border-box; 
      margin-bottom: 10px; 
      font-size: 14px;
      transition: border-color 0.3s ease;
    }
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: #3498db;
      box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
    }
    textarea { 
      resize: vertical; 
      min-height: 80px;
    }
    .checkbox-group {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
    }
    .checkbox-group label {
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 500;
      cursor: pointer;
    }
    .checkbox-group input[type="checkbox"] {
      width: auto;
      margin: 0;
    }
    .platform-tag { 
      padding: 4px 12px; 
      border-radius: 20px; 
      background-color: #e3f2fd; 
      color: #1976d2;
      font-size: 0.8em; 
      margin-right: 8px; 
      margin-bottom: 8px;
      display: inline-block;
      font-weight: 500;
    }
    .role-tone { 
      display: flex; 
      gap: 15px; 
      margin: 15px 0; 
      flex-wrap: wrap;
    }
    .role-tone span { 
      padding: 6px 12px; 
      border-radius: 20px; 
      font-size: 0.85em; 
      font-weight: 600; 
    }
    .role-tone .role { 
      background-color: #e3f2fd; 
      color: #1976d2; 
    }
    .role-tone .tone { 
      background-color: #f3e5f5; 
      color: #7b1fa2; 
    }
    .deployment-section { 
      margin-top: 20px; 
      padding: 20px; 
      border: 1px solid #e9ecef; 
      border-radius: 12px; 
      background-color: #f8f9fa; 
    }
    .deployment-section h5 { 
      margin: 0 0 15px 0; 
      color: #495057; 
      font-size: 1.1em;
    }
    .deployment-status { 
      font-size: 0.9em; 
      margin-top: 15px;
    }
    .deployment-status .whatsapp-status, .deployment-status .telegram-status { 
      padding: 6px 12px; 
      margin: 4px 0; 
      border-radius: 6px; 
      background-color: #e9ecef; 
      color: #6c757d; 
      display: inline-block;
    }
    .deployment-status .whatsapp-status.success, .deployment-status .telegram-status.success { 
      background-color: #d4edda; 
      color: #155724; 
    }
    .deployment-status .whatsapp-status.error, .deployment-status .telegram-status.error { 
      background-color: #f8d7da; 
      color: #721c24; 
    }
    .whatsapp-qr img { 
      max-width: 200px; 
      max-height: 200px; 
      border-radius: 8px;
      border: 2px solid #e9ecef;
    }
    #progressBar {
      width: 100%;
      background: #e9ecef;
      border-radius: 10px;
      height: 20px;
      margin-bottom: 10px;
      overflow: hidden;
      box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
    }
    .progress-bar-fill {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, #27ae60, #2ecc71);
      border-radius: 10px 0 0 10px;
      transition: width 0.3s ease;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    .debug-panel {
      margin-top: 40px;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 12px;
      border: 1px solid #e9ecef;
    }
    .debug-status {
      display: flex;
      gap: 20px;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }
    .debug-status span {
      font-weight: 600;
      color: #495057;
    }
    .status.info {
      color: #3498db;
      font-weight: 600;
    }
    .status.success {
      color: #27ae60;
      font-weight: 600;
    }
    .status.error {
      color: #e74c3c;
      font-weight: 600;
    }
    .debug-log {
      background: #2c3e50;
      color: #ecf0f1;
      padding: 15px;
      border-radius: 8px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      max-height: 200px;
      overflow-y: auto;
      margin-bottom: 15px;
    }
    .debug-log div {
      margin-bottom: 5px;
      padding: 2px 0;
    }
    .clear-btn {
      background: #95a5a6;
      font-size: 12px;
      padding: 8px 16px;
    }
    .clear-btn:hover {
      background: #7f8c8d;
    }
    #response {
      background: #f8f9fa;
      border: 1px solid #e9ecef;
      border-radius: 8px;
      padding: 15px;
      margin: 20px 0;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      white-space: pre-wrap;
      max-height: 300px;
      overflow-y: auto;
    }
    /* Modal Styles */
    #trainingModal, #telegramTokenModal {
      display: none;
      position: fixed;
      z-index: 10001;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      -webkit-backdrop-filter: blur(5px);
      backdrop-filter: blur(5px);
    }
    .modal-content {
      background-color: #fff;
      margin: 5% auto;
      padding: 30px;
      border-radius: 16px;
      width: 90%;
      max-width: 600px;
      position: relative;
      box-shadow: 0 20px 40px rgba(0,0,0,0.2);
      max-height: 80vh;
      overflow-y: auto;
    }
    .close-modal {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
      position: absolute;
      top: 15px;
      right: 20px;
    }
    .close-modal:hover {
      color: #000;
    }
    .training-status {
      padding: 10px;
      border-radius: 6px;
      font-weight: 600;
      margin-top: 10px;
    }
    .training-status.success {
      background: #d4edda;
      color: #155724;
    }
    .training-status.error {
      background: #f8d7da;
      color: #721c24;
    }
    .training-status.info {
      background: #d1ecf1;
      color: #0c5460;
    }
    /* Responsive Design */
    @media (max-width: 768px) {
      .container {
        margin: 10px;
        padding: 20px;
      }
      h1 {
        font-size: 2em;
      }
      .agent-actions, .deployment-options {
        flex-direction: column;
      }
      .role-tone {
        flex-direction: column;
        gap: 10px;
      }
      .debug-status {
        flex-direction: column;
        gap: 10px;
      }
      .modal-content {
        width: 95%;
        margin: 10% auto;
        padding: 20px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <button id="logoutBtn" class="logout-btn">Logout</button>
    <h1>AI Agent Dashboard</h1>
    <div id="agentSection">
      <h2>Agent Management</h2>
      <div class="agent-form">
        <h3>Create New Agent</h3>
        <div class="form-group">
          <label for="agent-name">Name:</label>
          <input type="text" id="agent-name" required>
        </div>
        <div class="form-group">
          <label for="agent-description">Description:</label>
          <textarea id="agent-description" rows="3"></textarea>
        </div>
        <div class="form-group">
          <label for="agent-role">Role:</label>
          <input type="text" id="agent-role" placeholder="e.g., Customer service assistant, Sales agent, etc." required>
        </div>
        <div class="form-group">
          <label for="agent-tone">Tone:</label>
          <select id="agent-tone" required>
            <option value="friendly">Friendly</option>
            <option value="professional">Professional</option>
            <option value="casual">Casual</option>
            <option value="formal">Formal</option>
            <option value="enthusiastic">Enthusiastic</option>
            <option value="calm">Calm</option>
            <option value="humorous">Humorous</option>
            <option value="serious">Serious</option>
            <option value="helpful">Helpful</option>
            <option value="authoritative">Authoritative</option>
          </select>
        </div>
        <div class="form-group">
          <label>Platforms:</label>
          <div class="checkbox-group">
            <label><input type="checkbox" name="platforms" value="whatsapp"> WhatsApp</label>
            <label><input type="checkbox" name="platforms" value="telegram"> Telegram</label>
            <label><input type="checkbox" name="platforms" value="iframe"> iFrame</label>
          </div>
        </div>
        <button id="createAgentBtn">Create Agent</button>
      </div>
      <div class="agent-list">
        <h3>Your Agents</h3>
        <div id="agentList"></div>
      </div>
    </div>
    <div id="response"></div>
    <div id="loadingOverlay"><div class="spinner"></div></div>
    <div id="toast"></div>
    <div class="debug-panel">
      <h3>Debug Panel</h3>
      <div class="debug-status">
        <span>Auth Status: <span id="authStatus" class="status info">Authenticated</span></span>
        <span>API Status: <span id="apiStatus" class="status info">Unknown</span></span>
      </div>
      <div class="debug-log" id="debugLog"></div>
      <button id="clearLogBtn" class="clear-btn">Clear Log</button>
    </div>
  </div>
  <div id="trainingModal" style="display:none;">
    <div class="modal-content">
      <span class="close-modal">&times;</span>
      <h2>Training Agent</h2>
      <div class="form-group">
        <label for="training-source">Source Type:</label>
        <select id="training-source">
          <option value="document">Document</option>
          <option value="audio">Audio</option>
          <option value="video">Video</option>
          <option value="website">Website</option>
          <option value="youtube">YouTube</option>
        </select>
      </div>
      <div class="form-group" id="training-files-group">
        <label for="training-files">Files:</label>
        <input type="file" id="training-files" multiple>
      </div>
      <div class="form-group" id="training-text-group">
        <label for="training-text">Text:</label>
        <textarea id="training-text" rows="3"></textarea>
      </div>
      <div class="form-group" id="training-url-group">
        <label for="training-url">URL:</label>
        <input type="text" id="training-url">
      </div>
      <div class="form-group">
        <label for="training-description">Description:</label>
        <textarea id="training-description" rows="3"></textarea>
      </div>
      <div class="form-group">
        <label for="training-status">Status:</label>
        <div id="trainingStatus" class="status info">Not started</div>
      </div>
      <div class="form-group">
        <label for="uploadProgress">Progress:</label>
        <div id="uploadProgress">
          <div id="progressBar">
            <div id="progressBarFill" class="progress-bar-fill"></div>
          </div>
        </div>
      </div>
      <button id="startTrainingBtn">Start Training</button>
    </div>
  </div>
  <div id="telegramTokenModal" style="display:none;">
    <div class="modal-content">
      <span class="close-modal" onclick="closeTelegramTokenModal()">&times;</span>
      <h2>Telegram Bot Token</h2>
      <div class="form-group">
        <label for="telegram-bot-token">Bot Token:</label>
        <input type="text" id="telegram-bot-token" placeholder="Enter your Telegram bot token (e.g., 123456789:ABCdefGHIjklMNOpqrsTUVwxyz)">
        <small style="color: #6c757d; font-size: 0.85em;">
          Get your bot token from <a href="https://t.me/botfather" target="_blank" rel="noopener" style="color: #3498db;">@BotFather</a> on Telegram
        </small>
      </div>
      <div class="form-group">
        <button id="confirmTelegramTokenBtn" style="margin-right: 10px;">Deploy to Telegram</button>
        <button onclick="closeTelegramTokenModal()" style="background: #95a5a6;">Cancel</button>
      </div>
    </div>
  </div>
  <script>
    const API_URL = 'http://localhost:5000/api';
    let accessToken = localStorage.getItem('accessToken');

    // Handle Google OAuth redirect with tokens
    function handleGoogleOAuthRedirect() {
      const urlParams = new URLSearchParams(window.location.search);
      const token = urlParams.get('token');
      const refreshToken = urlParams.get('refreshToken');
      const error = urlParams.get('error');
      
      if (error) {
        showToast('Google authentication failed. Please try again.', 'error');
        logDebug('Google OAuth error: ' + error, 'error');
        // Clean up URL
        window.history.replaceState({}, document.title, window.location.pathname);
        return;
      }
      
      if (token && refreshToken) {
        localStorage.setItem('accessToken', token);
        localStorage.setItem('refreshToken', refreshToken);
        accessToken = token;
        showToast('Successfully authenticated with Google!', 'success');
        logDebug('Google OAuth successful, tokens stored', 'success');
        // Clean up URL
        window.history.replaceState({}, document.title, window.location.pathname);
      }
    }

    // Check for Google OAuth redirect on page load
    handleGoogleOAuthRedirect();

    // Check if user is authenticated
    if (!accessToken) {
      window.location.href = 'login.html';
    }

    // Utility: Toast, Loading, Debug
    function showToast(msg, type = 'info') {
      const toast = document.getElementById('toast');
      toast.textContent = msg;
      toast.className = type;
      toast.style.display = 'block';
      setTimeout(() => { toast.style.display = 'none'; }, 2500);
    }
    function showLoading() {
      document.getElementById('loadingOverlay').style.display = 'flex';
    }
    function hideLoading() {
      document.getElementById('loadingOverlay').style.display = 'none';
    }
    function logDebug(message, type = 'info') {
      const debugLog = document.getElementById('debugLog');
      const timestamp = new Date().toLocaleTimeString();
      const logEntry = document.createElement('div');
      logEntry.className = `status ${type}`;
      logEntry.textContent = `[${timestamp}] ${message}`;
      debugLog.appendChild(logEntry);
      debugLog.scrollTop = debugLog.scrollHeight;
    }
    function clearDebugLog() {
      document.getElementById('debugLog').innerHTML = '';
    }

    // API request helper
    async function makeRequest(endpoint, options = {}) {
      try {
        logDebug(`Making ${options.method || 'GET'} request to ${endpoint}`, 'info');
        if (accessToken) {
          options.headers = {
            ...options.headers,
            'Authorization': `Bearer ${accessToken}`
          };
          logDebug('Added authentication token to request', 'info');
        }
        const response = await fetch(`${API_URL}${endpoint}`, {
          ...options,
          headers: {
            'Content-Type': 'application/json',
            ...options.headers
          }
        });
        const data = await response.json();
        if (!response.ok) {
          logDebug(`Request failed: ${data.error || data.message}`, 'error');
          throw new Error(data.error || data.message || 'Request failed');
        }
        logDebug(`Request successful: ${endpoint}`, 'success');
        showResponse(data);
        return data;
      } catch (error) {
        showResponse({ error: error.message }, true);
        throw error;
      }
    }

    function showResponse(data, error = false) {
      const responseEl = document.getElementById('response');
      responseEl.textContent = JSON.stringify(data, null, 2);
      responseEl.style.borderColor = error ? '#dc3545' : '#ddd';
      responseEl.style.backgroundColor = error ? '#fff5f5' : 'white';
    }

    document.getElementById('clearLogBtn').addEventListener('click', clearDebugLog);

    // Agent Management
    async function createAgent() {
      const name = document.getElementById('agent-name').value;
      const description = document.getElementById('agent-description').value;
      const role = document.getElementById('agent-role').value;
      const tone = document.getElementById('agent-tone').value;
      const platformCheckboxes = document.querySelectorAll('input[name="platforms"]:checked');
      const platforms = Array.from(platformCheckboxes).map(cb => cb.value);
      try {
        logDebug('Creating new agent...', 'info');
        showLoading();
        const data = await makeRequest('/agents', {
          method: 'POST',
          body: JSON.stringify({ name, description, role, tone, platforms })
        });
        hideLoading();
        document.getElementById('agent-name').value = '';
        document.getElementById('agent-description').value = '';
        document.getElementById('agent-role').value = '';
        document.getElementById('agent-tone').value = '';
        platformCheckboxes.forEach(cb => cb.checked = false);
        logDebug('Agent created successfully', 'success');
        showToast('Agent created successfully', 'success');
        loadAgents();
      } catch (error) {
        hideLoading();
        logDebug(`Failed to create agent: ${error.message}`, 'error');
        showToast(`Failed to create agent: ${error.message}`, 'error');
      }
    }

    document.getElementById('createAgentBtn').addEventListener('click', createAgent);

    document.getElementById('logoutBtn').addEventListener('click', function() {
      localStorage.removeItem('accessToken');
      localStorage.removeItem('refreshToken');
      window.location.href = 'login.html';
    });

    // Load and render agents
    async function loadAgents() {
      try {
        logDebug('Loading agents...', 'info');
        showLoading();
        const agents = await makeRequest('/agents');
        hideLoading();
        const agentList = document.getElementById('agentList');
        if (agents.length === 0) {
          agentList.innerHTML = '<p>No agents found. Create your first agent above!</p>';
          return;
        }
        agentList.innerHTML = agents.map(agent => `
          <div class="agent-card" data-agent-id="${agent.agentId}">
            <h4>${agent.name}</h4>
            <div class="role-tone">
              <span class="role">${agent.role || 'Not specified'}</span>
              <span class="tone">${agent.tone || 'friendly'}</span>
            </div>
            <p>${agent.description || 'No description'}</p>
            <div class="platforms">
              ${agent.platforms.map(p => `<span class="platform-tag">${p}</span>`).join('')}
            </div>
            <div class="agent-actions">
              <button class="delete-btn" data-agent-id="${agent.agentId}">Delete</button>
              <button class="deploy-btn" data-agent-id="${agent.agentId}">Deploy</button>
              <button class="train-btn" data-agent-id="${agent.agentId}">Train</button>
            </div>
            <div class="deployment-section">
              <h5>Deployments</h5>
              <div class="deployment-options">
                <button class="whatsapp-deploy-btn" data-agent-id="${agent.agentId}">Deploy to WhatsApp</button>
                <span class="whatsapp-management-btns" id="whatsapp-management-btns-${agent.agentId}" style="display:none;">
                  <button class="whatsapp-restart-btn" data-agent-id="${agent.agentId}">Restart WhatsApp</button>
                  <button class="whatsapp-disconnect-btn" data-agent-id="${agent.agentId}">Disconnect WhatsApp</button>
                  <button class="whatsapp-status-btn" data-agent-id="${agent.agentId}">Check WhatsApp Status</button>
                </span>
                <button class="telegram-deploy-btn" data-agent-id="${agent.agentId}">Deploy to Telegram</button>
                <span class="telegram-management-btns" id="telegram-management-btns-${agent.agentId}" style="display:none;">
                  <button class="telegram-restart-btn" data-agent-id="${agent.agentId}">Restart Telegram</button>
                  <button class="telegram-disconnect-btn" data-agent-id="${agent.agentId}">Disconnect Telegram</button>
                  <button class="telegram-status-btn" data-agent-id="${agent.agentId}">Check Telegram Status</button>
                </span>
              </div>
              <div class="deployment-status" id="deployment-status-${agent.agentId}">
                <div class="whatsapp-status" id="whatsapp-status-${agent.agentId}">WhatsApp: Not deployed</div>
                <div class="whatsapp-qr" id="whatsapp-qr-${agent.agentId}" style="margin:8px 0;"></div>
                <div class="telegram-status" id="telegram-status-${agent.agentId}">Telegram: Not deployed</div>
              </div>
            </div>
          </div>
        `).join('');
        // Attach event listeners for agent actions
        agentList.querySelectorAll('.delete-btn').forEach(btn => {
          btn.addEventListener('click', function() {
            const agentId = this.getAttribute('data-agent-id');
            deleteAgent(agentId);
          });
        });
        agentList.querySelectorAll('.deploy-btn').forEach(btn => {
          btn.addEventListener('click', function() {
            const agentId = this.getAttribute('data-agent-id');
            deployAgent(agentId);
          });
        });
        agentList.querySelectorAll('.train-btn').forEach(btn => {
          btn.addEventListener('click', function() {
            const agentId = this.getAttribute('data-agent-id');
            openTrainingModal(agentId);
          });
        });
        // WhatsApp management
        agentList.querySelectorAll('.whatsapp-deploy-btn').forEach(btn => {
          btn.addEventListener('click', function() {
            const agentId = this.getAttribute('data-agent-id');
            deployWhatsapp(agentId);
          });
        });
        agentList.querySelectorAll('.whatsapp-restart-btn').forEach(btn => {
          btn.addEventListener('click', function() {
            const agentId = this.getAttribute('data-agent-id');
            restartWhatsapp(agentId);
          });
        });
        agentList.querySelectorAll('.whatsapp-disconnect-btn').forEach(btn => {
          btn.addEventListener('click', function() {
            const agentId = this.getAttribute('data-agent-id');
            disconnectWhatsapp(agentId);
          });
        });
        agentList.querySelectorAll('.whatsapp-status-btn').forEach(btn => {
          btn.addEventListener('click', function() {
            const agentId = this.getAttribute('data-agent-id');
            checkWhatsappStatus(agentId);
          });
        });
        // Telegram management
        agentList.querySelectorAll('.telegram-deploy-btn').forEach(btn => {
          btn.addEventListener('click', function() {
            const agentId = this.getAttribute('data-agent-id');
            deployTelegram(agentId);
          });
        });
        agentList.querySelectorAll('.telegram-restart-btn').forEach(btn => {
          btn.addEventListener('click', function() {
            const agentId = this.getAttribute('data-agent-id');
            restartTelegram(agentId);
          });
        });
        agentList.querySelectorAll('.telegram-disconnect-btn').forEach(btn => {
          btn.addEventListener('click', function() {
            const agentId = this.getAttribute('data-agent-id');
            disconnectTelegram(agentId);
          });
        });
        agentList.querySelectorAll('.telegram-status-btn').forEach(btn => {
          btn.addEventListener('click', function() {
            const agentId = this.getAttribute('data-agent-id');
            checkTelegramStatus(agentId);
          });
        });
        logDebug('Agents loaded successfully', 'success');
      } catch (error) {
        hideLoading();
        logDebug(`Failed to load agents: ${error.message}`, 'error');
        showToast(`Failed to load agents: ${error.message}`, 'error');
      }
    }

    // Agent actions
    async function deleteAgent(agentId) {
      if (!confirm('Are you sure you want to delete this agent?')) return;
      try {
        logDebug(`Deleting agent ${agentId}...`, 'info');
        showLoading();
        await makeRequest(`/agents/${agentId}`, { method: 'DELETE' });
        hideLoading();
        logDebug('Agent deleted successfully', 'success');
        showToast('Agent deleted successfully', 'success');
        loadAgents();
      } catch (error) {
        hideLoading();
        logDebug(`Failed to delete agent: ${error.message}`, 'error');
        showToast(`Failed to delete agent: ${error.message}`, 'error');
      }
    }

    async function deployAgent(agentId) {
      try {
        logDebug(`Deploying agent ${agentId}...`, 'info');
        showLoading();
        await makeRequest(`/agents/${agentId}/deployments`, {
          method: 'POST',
          body: JSON.stringify({ type: 'iframe', config: { url: `${window.location.origin}/agent/${agentId}` } })
        });
        hideLoading();
        logDebug('Agent deployed successfully', 'success');
        showToast('Agent deployed successfully', 'success');
        loadAgents();
      } catch (error) {
        hideLoading();
        logDebug(`Failed to deploy agent: ${error.message}`, 'error');
        showToast(`Failed to deploy agent: ${error.message}`, 'error');
      }
    }

    // WhatsApp Management
    async function deployWhatsapp(agentId) {
      try {
        logDebug(`Deploying agent ${agentId} to WhatsApp...`, 'info');
        showLoading();
        const response = await makeRequest(`/agents/${agentId}/whatsapp/deploy`, { method: 'POST' });
        hideLoading();
        if (response.status === 'qr') {
          logDebug('WhatsApp QR code generated. Please scan with your phone.', 'info');
          updateWhatsappStatus(agentId, 'QR Code Generated - Please scan');
          showWhatsappQR(agentId, response.qr);
        } else if (response.status === 'connected') {
          logDebug('WhatsApp connected successfully', 'success');
          updateWhatsappStatus(agentId, 'Connected');
          showWhatsappQR(agentId, null);
        }
      } catch (error) {
        hideLoading();
        logDebug(`Failed to deploy WhatsApp: ${error.message}`, 'error');
        updateWhatsappStatus(agentId, 'Deployment Failed');
        showWhatsappQR(agentId, null);
        showToast(`Failed to deploy WhatsApp: ${error.message}`, 'error');
      }
    }

    async function restartWhatsapp(agentId) {
      try {
        logDebug(`Restarting WhatsApp for agent ${agentId}...`, 'info');
        showLoading();
        await makeRequest(`/agents/${agentId}/whatsapp/restart`, { method: 'POST' });
        hideLoading();
        logDebug('WhatsApp restarted successfully', 'success');
        updateWhatsappStatus(agentId, 'Restarted');
        checkWhatsappStatus(agentId);
      } catch (error) {
        hideLoading();
        logDebug(`Failed to restart WhatsApp: ${error.message}`, 'error');
        updateWhatsappStatus(agentId, 'Restart Failed');
        showToast(`Failed to restart WhatsApp: ${error.message}`, 'error');
      }
    }

    async function disconnectWhatsapp(agentId) {
      try {
        logDebug(`Disconnecting WhatsApp for agent ${agentId}...`, 'info');
        showLoading();
        await makeRequest(`/agents/${agentId}/whatsapp/disconnect`, { method: 'POST' });
        hideLoading();
        logDebug('WhatsApp disconnected successfully', 'success');
        updateWhatsappStatus(agentId, 'Disconnected');
        showWhatsappQR(agentId, null);
      } catch (error) {
        hideLoading();
        logDebug(`Failed to disconnect WhatsApp: ${error.message}`, 'error');
        updateWhatsappStatus(agentId, 'Disconnect Failed');
        showToast(`Failed to disconnect WhatsApp: ${error.message}`, 'error');
      }
    }

    async function checkWhatsappStatus(agentId) {
      try {
        logDebug(`Checking WhatsApp status for agent ${agentId}...`, 'info');
        showLoading();
        const response = await makeRequest(`/agents/${agentId}/whatsapp/status`);
        hideLoading();
        updateWhatsappStatus(agentId, response.status || 'Unknown');
        if (response.status === 'qr' && response.qr) {
          showWhatsappQR(agentId, response.qr);
        } else {
          showWhatsappQR(agentId, null);
        }
      } catch (error) {
        hideLoading();
        logDebug(`Failed to get WhatsApp status: ${error.message}`, 'error');
        updateWhatsappStatus(agentId, 'Status Check Failed');
        showWhatsappQR(agentId, null);
        showToast(`Failed to get WhatsApp status: ${error.message}`, 'error');
      }
    }

    function updateWhatsappStatus(agentId, status) {
      const statusElement = document.getElementById(`whatsapp-status-${agentId}`);
      const btns = document.getElementById(`whatsapp-management-btns-${agentId}`);
      let badgeClass = 'unknown';
      if (status) {
        if (status.toLowerCase().includes('connected')) badgeClass = 'connected';
        else if (status.toLowerCase().includes('disconnected')) badgeClass = 'disconnected';
        else if (status.toLowerCase().includes('qr')) badgeClass = 'qr';
        else if (status.toLowerCase().includes('fail')) badgeClass = 'error';
      }
      if (statusElement) {
        statusElement.innerHTML = `WhatsApp: <span class='status-badge ${badgeClass}'>${status}</span>`;
      }
      if (btns) {
        if (status && status.toLowerCase().includes('connected')) {
          btns.style.display = '';
        } else {
          btns.style.display = 'none';
        }
      }
    }

    function showWhatsappQR(agentId, qrDataUrl) {
      const qrDiv = document.getElementById(`whatsapp-qr-${agentId}`);
      if (qrDiv) {
        if (qrDataUrl) {
          qrDiv.innerHTML = `<img src="${qrDataUrl}" alt="WhatsApp QR Code" style="max-width:200px;max-height:200px;">`;
        } else {
          qrDiv.innerHTML = '';
        }
      }
    }

    // Telegram Management
    async function deployTelegram(agentId) {
      // Open the Telegram token modal instead of using prompt
      openTelegramTokenModal(agentId);
    }

    async function restartTelegram(agentId) {
      try {
        logDebug(`Restarting Telegram for agent ${agentId}...`, 'info');
        showLoading();
        await makeRequest(`/agents/${agentId}/telegram/restart`, { method: 'POST' });
        hideLoading();
        logDebug('Telegram restarted successfully', 'success');
        updateTelegramStatus(agentId, 'Restarted');
        checkTelegramStatus(agentId);
      } catch (error) {
        hideLoading();
        logDebug(`Failed to restart Telegram: ${error.message}`, 'error');
        updateTelegramStatus(agentId, 'Restart Failed');
        showToast(`Failed to restart Telegram: ${error.message}`, 'error');
      }
    }

    async function disconnectTelegram(agentId) {
      try {
        logDebug(`Disconnecting Telegram for agent ${agentId}...`, 'info');
        showLoading();
        await makeRequest(`/agents/${agentId}/telegram/disconnect`, { method: 'POST' });
        hideLoading();
        logDebug('Telegram disconnected successfully', 'success');
        updateTelegramStatus(agentId, 'Disconnected');
      } catch (error) {
        hideLoading();
        logDebug(`Failed to disconnect Telegram: ${error.message}`, 'error');
        updateTelegramStatus(agentId, 'Disconnect Failed');
        showToast(`Failed to disconnect Telegram: ${error.message}`, 'error');
      }
    }

    async function checkTelegramStatus(agentId) {
      try {
        logDebug(`Checking Telegram status for agent ${agentId}...`, 'info');
        showLoading();
        const response = await makeRequest(`/agents/${agentId}/telegram/status`);
        hideLoading();
        updateTelegramStatus(agentId, response.status || 'Unknown');
      } catch (error) {
        hideLoading();
        logDebug(`Failed to get Telegram status: ${error.message}`, 'error');
        updateTelegramStatus(agentId, 'Status Check Failed');
        showToast(`Failed to get Telegram status: ${error.message}`, 'error');
      }
    }

    function updateTelegramStatus(agentId, status) {
      const statusElement = document.getElementById(`telegram-status-${agentId}`);
      const btns = document.getElementById(`telegram-management-btns-${agentId}`);
      let badgeClass = 'unknown';
      if (status) {
        if (status.toLowerCase().includes('deployed') || status.toLowerCase().includes('connected')) badgeClass = 'connected';
        else if (status.toLowerCase().includes('disconnected')) badgeClass = 'disconnected';
        else if (status.toLowerCase().includes('qr')) badgeClass = 'qr';
        else if (status.toLowerCase().includes('fail')) badgeClass = 'error';
      }
      if (statusElement) {
        statusElement.innerHTML = `Telegram: <span class='status-badge ${badgeClass}'>${status}</span>`;
      }
      if (btns) {
        if (status && (status.toLowerCase().includes('deployed') || status.toLowerCase().includes('connected'))) {
          btns.style.display = '';
        } else {
          btns.style.display = 'none';
        }
      }
    }

    // Training Modal Logic
    let currentTrainingAgent = null;
    let trainingCheckInterval = null;
    let currentTelegramAgent = null;

    function openTrainingModal(agentId) {
      currentTrainingAgent = agentId;
      document.getElementById('trainingModal').style.display = 'block';
      document.getElementById('trainingStatus').textContent = '';
      document.getElementById('training-text').value = '';
      document.getElementById('training-url').value = '';
      document.getElementById('training-description').value = '';
      document.getElementById('training-files').value = '';
      document.getElementById('uploadProgress').style.display = 'none';
    }
    function closeTrainingModal() {
      document.getElementById('trainingModal').style.display = 'none';
      if (trainingCheckInterval) clearInterval(trainingCheckInterval);
    }
    document.getElementById('training-source').addEventListener('change', function() {
      const source = this.value;
      document.getElementById('training-files-group').style.display = (source === 'document' || source === 'audio' || source === 'video') ? 'block' : 'none';
      document.getElementById('training-text-group').style.display = (source === 'document') ? 'block' : 'none';
      document.getElementById('training-url-group').style.display = (source === 'website' || source === 'youtube') ? 'block' : 'none';
    });
    document.querySelector('.close-modal').onclick = closeTrainingModal;
    document.getElementById('startTrainingBtn').onclick = async function() {
      const sourceType = document.getElementById('training-source').value;
      const files = document.getElementById('training-files').files;
      const text = document.getElementById('training-text').value;
      const url = document.getElementById('training-url').value;
      const description = document.getElementById('training-description').value;
      const statusDiv = document.getElementById('trainingStatus');
      const progressBar = document.getElementById('uploadProgress');
      progressBar.style.display = 'block';
      progressBar.querySelector('.progress-bar-fill').style.width = '0%';
      try {
        logDebug('Starting agent training...', 'info');
        showLoading();
        const formData = new FormData();
        formData.append('sourceType', sourceType);
        formData.append('description', description);
        if (files && files.length > 0) {
          for (let i = 0; i < files.length; i++) {
            formData.append('files', files[i]);
          }
        }
        if (text) formData.append('text', text);
        if (url) formData.append('url', url);
        const xhr = new XMLHttpRequest();
        xhr.open('POST', `${API_URL}/agent/train?agentId=${currentTrainingAgent}`);
        xhr.setRequestHeader('Authorization', `Bearer ${accessToken}`);
        xhr.upload.onprogress = function(e) {
          if (e.lengthComputable) {
            const percent = Math.round((e.loaded / e.total) * 100);
            progressBar.querySelector('.progress-bar-fill').style.width = percent + '%';
          }
        };
        xhr.onload = function() {
          hideLoading();
          if (xhr.status === 200) {
            statusDiv.textContent = 'Training started!';
            statusDiv.className = 'training-status success';
            logDebug('Training started successfully', 'success');
            showToast('Training started!', 'success');
            closeTrainingModal();
          } else {
            statusDiv.textContent = 'Training failed: ' + xhr.responseText;
            statusDiv.className = 'training-status error';
            logDebug('Training failed: ' + xhr.responseText, 'error');
            showToast('Training failed', 'error');
          }
        };
        xhr.onerror = function() {
          hideLoading();
          statusDiv.textContent = 'Training failed: Network error';
          statusDiv.className = 'training-status error';
          logDebug('Training failed: Network error', 'error');
          showToast('Training failed: Network error', 'error');
        };
        xhr.send(formData);
      } catch (error) {
        hideLoading();
        statusDiv.textContent = 'Training failed: ' + error.message;
        statusDiv.className = 'training-status error';
        logDebug('Training failed: ' + error.message, 'error');
        showToast('Training failed: ' + error.message, 'error');
      }
    };

    // Telegram Token Modal Logic
    function openTelegramTokenModal(agentId) {
      currentTelegramAgent = agentId;
      document.getElementById('telegramTokenModal').style.display = 'block';
      document.getElementById('telegram-bot-token').value = '';
    }

    function closeTelegramTokenModal() {
      document.getElementById('telegramTokenModal').style.display = 'none';
      currentTelegramAgent = null;
    }

    // Telegram Token Modal Event Listener
    document.getElementById('confirmTelegramTokenBtn').addEventListener('click', async function() {
      const botToken = document.getElementById('telegram-bot-token').value.trim();
      if (!botToken) {
        showToast('Please enter a valid bot token', 'error');
        return;
      }
      
      try {
        logDebug(`Deploying agent ${currentTelegramAgent} to Telegram...`, 'info');
        updateTelegramStatus(currentTelegramAgent, 'Deploying...');
        showLoading();
        const response = await makeRequest(`/agents/${currentTelegramAgent}/telegram/deploy`, {
          method: 'POST',
          body: JSON.stringify({ botToken })
        });
        hideLoading();
        if (response.success || response.status === 'deployed' || response.botInfo) {
          logDebug('Telegram bot deployed successfully', 'success');
          updateTelegramStatus(currentTelegramAgent, 'Deployed');
          showResponse(response);
          showToast('Telegram bot deployed successfully', 'success');
          checkTelegramStatus(currentTelegramAgent);
          closeTelegramTokenModal();
        } else {
          throw new Error(response.error || 'Deployment failed');
        }
      } catch (error) {
        hideLoading();
        logDebug(`Failed to deploy Telegram: ${error.message}`, 'error');
        updateTelegramStatus(currentTelegramAgent, 'Deployment Failed');
        showToast(`Failed to deploy Telegram: ${error.message}`, 'error');
      }
    });

    // Initial load
    loadAgents();
  </script>
</body>
</html> 